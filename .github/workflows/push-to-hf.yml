name: Push demo branch to Hugging Face

on:
  workflow_call:
    inputs:
      ref:
        required: false
        default: demo
        type: string
    secrets:
      HF_TOKEN:
        required: true

jobs:
  push-hf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git identity
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name  "github-actions[bot]"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub

    - name: Push to Hugging Face
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_REPO_TYPE: spaces
        HF_REPO_ID: chenzihong/GraphGen
      run: |
        git config --global credential.helper store
        echo "https://user:${HF_TOKEN}@huggingface.co" > ~/.git-credentials

        [[ -d hf-repo ]] && rm -rf hf-repo
        git clone https://huggingface.co/${HF_REPO_TYPE}/${HF_REPO_ID} hf-repo

        rsync -a --delete --exclude='.git' --exclude='hf-repo' ./ hf-repo/

        cd hf-repo
        git add .
        git diff-index --quiet HEAD || \
          (git commit -m "Auto-sync from ${{ inputs.ref }} at $(date -u)" && git push)